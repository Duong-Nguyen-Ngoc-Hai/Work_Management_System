{% extends "base.html" %}

{% block title %}Reports - Work Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2><i class="fas fa-chart-bar me-2"></i>Reports Management</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#generateReportModal">
                            <i class="fas fa-plus me-2"></i>Generate Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-file-alt fa-2x mb-3"></i>
                    <div class="h4" id="totalReports">0</div>
                    <div>Total Reports</div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-calendar-week fa-2x mb-3"></i>
                    <div class="h4" id="thisWeekReports">0</div>
                    <div>This Week</div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-calendar-alt fa-2x mb-3"></i>
                    <div class="h4" id="thisMonthReports">0</div>
                    <div>This Month</div>
                </div>
            </div>
        </div>
        <!-- ✅ XÓA DOWNLOADS CARD -->
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-filter me-2"></i>Filters</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Report Type</label>
                            <select class="form-control" id="filterType">
                                <option value="">All Types</option>
                                <option value="weekly">Weekly Report</option>
                                <option value="summary">Summary Report</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Format</label>
                            <select class="form-control" id="filterFormat">
                                <option value="">All Formats</option>
                                <option value="excel">Excel</option>
                                <option value="pdf">PDF</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Date From</label>
                            <input type="date" class="form-control" id="filterDateFrom">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Date To</label>
                            <input type="date" class="form-control" id="filterDateTo">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <button class="btn btn-primary me-2" onclick="applyFilters()">
                                <i class="fas fa-search"></i> Apply Filters
                            </button>
                            <button class="btn btn-secondary" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list me-2"></i>Reports</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Filename</th>
                                    <th>Type</th>
                                    <th>Format</th>
                                    <th>Week</th>
                                    <th>Created By</th>
                                    <th>Created Date</th>
                                    <th>Size</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reportsTableBody">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div id="reportsPaginationInfo" class="text-muted">
                            Showing 0 reports
                        </div>
                        <nav aria-label="Reports pagination">
                            <ul class="pagination pagination-sm mb-0" id="reportsPagination">
                                <!-- Pagination items will be generated here -->
                            </ul>
                        </nav>
                    </div>
                    <div id="reportsFilterResults" class="alert alert-info py-2 mt-3" style="display: none;">
                        <i class="fas fa-filter me-2"></i>
                        <span id="reportsFilterResultsText"></span>
                        <button type="button" class="btn-close btn-sm ms-2" onclick="clearFilters()" style="font-size: 0.8rem;"></button>
                    </div>
                    
                    <!-- ✅ THÊM MODAL XEM BÁO CÁO -->
                    <!-- View Report Detail Modal -->
                    <div id="viewReportOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; max-width: 800px; width: 90%; max-height: 80%; overflow-y: auto;">
                            <div style="padding: 20px; border-bottom: 1px solid #dee2e6;">
                                <h5 id="viewReportTitle">Report Details</h5>
                                <button onclick="closeReportView()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                            </div>
                            <div id="viewReportContent" style="padding: 20px;">
                                <!-- Content will be loaded here -->
                            </div>
                            <div style="padding: 20px; border-top: 1px solid #dee2e6; text-align: right;">
                                <button onclick="closeReportView()" class="btn btn-secondary me-2">Close</button>
                                <button id="downloadFromView" class="btn btn-primary">
                                    <i class="fas fa-download me-2"></i>Download
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Generate Report Modal -->
<div class="modal fade" id="generateReportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generate New Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="generateReportForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Report Type</label>
                            <select class="form-control" name="report_type" id="reportType" required>
                                <option value="">Select type...</option>
                                <option value="weekly">Weekly Report</option>
                                <option value="summary" id="summaryOption" style="display: none;">Summary Report (Admin/Leader only)</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Format</label>
                            <select class="form-control" name="format" required>
                                <option value="excel">Excel (.xlsx)</option>
                                <option value="pdf">PDF (.pdf)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Weekly Report Options -->
                    <div id="weeklyOptions" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Select Week</label>
                                <input type="week" class="form-control" name="week" id="weekInput">
                            </div>
                            <div class="col-md-6 mb-3" id="userSelectDiv">
                                <label class="form-label">User (Admin/Leader only)</label>
                                <select class="form-control" name="target_user_id" id="userSelect">
                                    <option value="">My reports only</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Report Options -->
                    <div id="summaryOptions" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Select Week</label>
                                <input type="week" class="form-control" name="summary_week" id="summaryWeekInput">
                            </div>
                            <div class="col-md-6 mb-3" id="groupSelectDiv">
                                <label class="form-label">Group (Admin only)</label>
                                <select class="form-control" name="group_id" id="groupSelect">
                                    <option value="">All groups</option>
                                </select>
                            </div>
                        </div>
                        <!-- ✅ Thêm thông tin scope -->
                        <div class="row">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <small id="summaryScope">Select options above</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-cog fa-spin me-2" id="generateSpinner" style="display: none;"></i>
                        Generate Report
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* ✅ FIX MODAL POSITIONING - LOẠI BỎ ANIMATION */
.modal {
    display: none;
}

.modal.show {
    display: block !important;
}

.modal-dialog {
    margin: 30px auto !important;
    position: static !important;
    transform: none !important;
    transition: none !important;
}

/* ✅ XÓA FADE ANIMATION */
.modal.fade .modal-dialog {
    transform: none !important;
    transition: none !important;
}

.modal.fade {
    opacity: 1 !important;
}

/* ✅ FIX BACKDROP */
.modal-backdrop {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    z-index: 1040 !important;
    background-color: rgba(0, 0, 0, 0.5) !important;
}

/* ✅ PREVENT BODY SCROLL */
body.modal-open {
    overflow: hidden !important;
    padding-right: 0 !important;
}

/* ✅ DISABLE CENTERING */
.modal-dialog-centered {
    display: block !important;
    align-items: unset !important;
    min-height: unset !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentReports = [];
let filteredReports = []; // ✅ THÊM: Lưu trữ reports đã filter
let currentPage = 1;
let reportsPerPage = 10;
let isFiltering = false; // ✅ THÊM: Flag để biết user có đang filter không

$(document).ready(function() {
    // Initialize
    const currentUser = WorkManagement.currentUser();
    if (!currentUser) {
        window.location.href = '/login';
        return;
    }
    
    initializeUI(currentUser);
    loadReports();
    loadSelectOptions();
    loadStatistics();
    setupEventHandlers();
});

function initializeUI(user) {
    // Show summary option for admin/leader only
    if (user.role === 'admin' || user.role === 'leader') {
        $('#summaryOption').show();
    }
    
    // Hide user selection for employees
    if (user.role === 'employee') {
        $('#userSelectDiv').hide();
    }
}

function setupEventHandlers() {
    // Report type change
    $('#reportType').on('change', function() {
        const type = $(this).val();
        const user = WorkManagement.currentUser();
        
        $('#weeklyOptions, #summaryOptions').hide();
        
        if (type === 'weekly') {
            $('#weeklyOptions').show();
            setCurrentWeek('#weekInput');
        } else if (type === 'summary') {
            if (user.role === 'admin' || user.role === 'leader') {
                $('#summaryOptions').show();
                setCurrentWeek('#summaryWeekInput');
                
                if (user.role === 'leader') {
                    $('#summaryScope').text(`Report will include tasks from your group only`);
                } else {
                    $('#summaryScope').text(`Select a group or leave empty for all groups`);
                }
            } else {
                showAlert('warning', 'Summary reports are only for admin and leaders');
                $(this).val('');
            }
        }
    });
    
    // Form submission
    $('#generateReportForm').on('submit', function(e) {
        e.preventDefault();
        generateReport();
    });
    
    // ✅ SỬA: Auto-apply filters on change
    $('#filterType').on('change', function() {
        isFiltering = $(this).val() !== '';
        applyFilters();
    });
    
    $('#filterFormat').on('change', function() {
        isFiltering = $(this).val() !== '';
        applyFilters();
    });
    
    $('#filterDateFrom').on('change', function() {
        isFiltering = $(this).val() !== '';
        applyFilters();
    });
    
    $('#filterDateTo').on('change', function() {
        isFiltering = $(this).val() !== '';
        applyFilters();
    });
}

function setCurrentWeek(selector) {
    const now = new Date();
    const year = now.getFullYear();
    const week = getWeekNumber(now);
    $(selector).val(`${year}-W${week.toString().padStart(2, '0')}`);
}

function getWeekNumber(date) {
    const d = new Date(date);
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

async function loadReports() {
    const user = WorkManagement.currentUser();
    
    try {
        const reports = await apiCall(`/reports/list?user_id=${user.id}`);
        currentReports = Array.isArray(reports) ? reports : [];
        
        // ✅ Chỉ hiển thị lại nếu user KHÔNG đang filter
        if (!isFiltering) {
            filteredReports = [...currentReports];
            currentPage = 1;
            displayReportsWithPagination(filteredReports);
        }
        
    } catch (error) {
        console.error('Error loading reports:', error);
        currentReports = [];
        if (!isFiltering) {
            filteredReports = [];
            displayReportsWithPagination([]);
        }
    }
}

async function loadSelectOptions() {
    try {
        const user = WorkManagement.currentUser();
        
        // ✅ Load users for admin/leader để tạo weekly report cho user khác
        if (user.role === 'admin' || user.role === 'leader') {
            let usersEndpoint = '/users/employees';
            
            // ✅ Leader chỉ thấy users trong nhóm của mình
            if (user.role === 'leader' && user.group_id) {
                usersEndpoint = `/users/all?group_id=${user.group_id}`;
            }
            
            const users = await apiCall(usersEndpoint);
            const userSelect = $('#userSelect');
            
            if (Array.isArray(users)) {
                users.forEach(emp => {
                    userSelect.append(`<option value="${emp.id}">${emp.name} (${emp.employee_code || emp.id})</option>`);
                });
            }
        }
        
        // ✅ Load groups cho summary report
        // Admin: tất cả groups + option "All groups"
        // Leader: chỉ group của mình (ẩn dropdown)
        if (user.role === 'admin') {
            const groups = await apiCall('/groups/all');
            const groupSelect = $('#groupSelect');
            
            if (Array.isArray(groups)) {
                groups.forEach(group => {
                    groupSelect.append(`<option value="${group.id}">${group.name}</option>`);
                });
            }
        } else if (user.role === 'leader') {
            // ✅ Leader: ẩn group selector vì chỉ có thể tạo cho nhóm của mình
            $('#groupSelectDiv').hide();
        }
        
    } catch (error) {
        console.error('Error loading options:', error);
    }
}

async function loadStatistics() {
    try {
        const user = WorkManagement.currentUser();
        const stats = await apiCall(`/reports/stats?user_id=${user.id}`);
        
        $('#totalReports').text(stats.total || 0);
        $('#thisWeekReports').text(stats.this_week || 0);
        $('#thisMonthReports').text(stats.this_month || 0);
        // ✅ XÓA dòng totalDownloads
        
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

function displayReportsWithPagination(reports) {
    const totalReports = reports.length;
    const totalPages = Math.ceil(totalReports / reportsPerPage);
    const startIndex = (currentPage - 1) * reportsPerPage;
    const endIndex = startIndex + reportsPerPage;
    const reportsToShow = reports.slice(startIndex, endIndex);
    
    // Hiển thị reports cho trang hiện tại
    displayReportsTable(reportsToShow);
    updateReportsPaginationInfo(totalReports, startIndex, endIndex);
    generateReportsPagination(totalPages);
}

function displayReportsTable(reports) {
    const tbody = $('#reportsTableBody');
    tbody.empty();
    
    if (reports.length === 0) {
        tbody.append('<tr><td colspan="8" class="text-center text-muted">No reports found</td></tr>');
        return;
    }
    
    reports.forEach(report => {
        const row = `
            <tr>
                <td>
                    <div>
                        <strong>${report.filename}</strong>
                        <br><small class="text-muted">${report.report_type}</small>
                    </div>
                </td>
                <td><span class="badge bg-${getTypeColor(report.report_type)}">${report.report_type}</span></td>
                <td><span class="badge bg-info">${report.format}</span></td>
                <td>${report.week_period}</td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 12px;">
                            ${(report.created_by || 'U').charAt(0).toUpperCase()}
                        </div>
                        <span>${report.created_by}</span>
                    </div>
                </td>
                <td>${formatDate(report.created_at)}</td>
                <td><span class="badge bg-info">${formatFileSize(report.file_size)}</span></td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-info" onclick="viewReport(${report.id})" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="downloadReport(${report.id})" title="Download">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteReport(${report.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

function updateReportsPaginationInfo(total, start, end) {
    const showing = Math.min(end, total);
    const text = total > 0 ? 
        `Showing ${start + 1}-${showing} of ${total} reports` : 
        'No reports found';
    $('#reportsPaginationInfo').text(text);
}

function generateReportsPagination(totalPages) {
    const pagination = $('#reportsPagination');
    pagination.empty();
    
    if (totalPages <= 1) return;
    
    // Previous button
    pagination.append(`
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changeReportsPage(${currentPage - 1})" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>
    `);
    
    // Page numbers
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    // Adjust start if we're near the end
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        pagination.append(`
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changeReportsPage(${i})">${i}</a>
            </li>
        `);
    }
    
    // Next button
    pagination.append(`
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changeReportsPage(${currentPage + 1})" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
    `);
}

function changeReportsPage(page) {
    const totalReports = isFiltering ? filteredReports.length : currentReports.length;
    const totalPages = Math.ceil(totalReports / reportsPerPage);
    
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    const reportsToDisplay = isFiltering ? filteredReports : currentReports;
    displayReportsWithPagination(reportsToDisplay);
}

function displayReports(reports) {
    filteredReports = reports;
    currentPage = 1; // Reset về trang 1
    displayReportsWithPagination(reports);
}


function viewReport(reportId) {
    const report = currentReports.find(r => r.id === reportId);
    if (!report) {
        showAlert('danger', 'Report not found');
        return;
    }
    
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6>Basic Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Filename:</strong></td><td>${report.filename}</td></tr>
                    <tr><td><strong>Type:</strong></td><td><span class="badge bg-${getTypeColor(report.report_type)}">${report.report_type}</span></td></tr>
                    <tr><td><strong>Format:</strong></td><td><span class="badge bg-info">${report.format}</span></td></tr>
                    <tr><td><strong>Size:</strong></td><td>${formatFileSize(report.file_size)}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Report Details</h6>
                <table class="table table-sm">
                    <tr><td><strong>Created By:</strong></td><td>${report.created_by}</td></tr>
                    <tr><td><strong>Created:</strong></td><td>${formatDate(report.created_at)}</td></tr>
                    <tr><td><strong>Week Period:</strong></td><td>${report.week_period}</td></tr>
                </table>
            </div>
        </div>
    `;
    
    $('#viewReportContent').html(content);
    $('#viewReportTitle').text(`${report.filename}`);
    $('#downloadFromView').off('click').on('click', () => {
        downloadReport(reportId);
        closeReportView();
    });
    
    // Hiển thị overlay
    $('#viewReportOverlay').fadeIn(200);
}

function closeReportView() {
    $('#viewReportOverlay').fadeOut(200);
}

function closeModal() {
    const modal = $('#viewReportModal');
    
    // Ẩn modal
    modal.removeClass('show').css('display', 'none');
    $('body').removeClass('modal-open');
    
    // Xóa backdrop
    $('.modal-backdrop').remove();
    
    // Xóa event listeners
    $(document).off('keydown.modal');
    modal.off('click');
}

// ✅ THÊM FUNCTION DESCRIPTION
function getReportDescription(report) {
    if (report.report_type === 'weekly') {
        return `This is a weekly report for ${report.week_period}. It contains tasks and activities for the specified week period.`;
    } else {
        return `This is a summary report for ${report.week_period}. It provides an overview of all tasks and team performance for the specified week.`;
    }
}

function getTypeColor(type) {
    return type === 'weekly' ? 'primary' : 'success';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function applyFilters() {
    const filters = {
        type: $('#filterType').val(),
        format: $('#filterFormat').val(),
        date_from: $('#filterDateFrom').val(),
        date_to: $('#filterDateTo').val()
    };
    
    // ✅ Cập nhật filtering state
    isFiltering = filters.type || filters.format || filters.date_from || filters.date_to;
    
    let filtered = [...currentReports];
    
    if (filters.type) {
        filtered = filtered.filter(report => report.report_type === filters.type);
    }
    
    if (filters.format) {
        filtered = filtered.filter(report => report.format === filters.format);
    }
    
    if (filters.date_from) {
        const fromDate = new Date(filters.date_from);
        filtered = filtered.filter(report => {
            const reportDate = new Date(report.created_at);
            return reportDate >= fromDate;
        });
    }
    
    if (filters.date_to) {
        const toDate = new Date(filters.date_to);
        toDate.setHours(23, 59, 59, 999);
        filtered = filtered.filter(report => {
            const reportDate = new Date(report.created_at);
            return reportDate <= toDate;
        });
    }
    
    // ✅ Lưu filtered reports và reset về trang 1
    filteredReports = filtered;
    currentPage = 1;
    
    // ✅ Hiển thị số lượng kết quả filter
    updateReportsFilterResults(filtered.length, currentReports.length);
    
    displayReportsWithPagination(filtered);
}

// ✅ Thêm function để hiển thị filter results
function updateReportsFilterResults(filteredCount, totalCount) {
    const resultsElement = $('#reportsFilterResults');
    
    if (filteredCount < totalCount) {
        $('#reportsFilterResultsText').text(`Showing ${filteredCount} of ${totalCount} reports`);
        resultsElement.show();
    } else {
        resultsElement.hide();
    }
}

function clearFilters() {
    $('#filterType, #filterFormat, #filterDateFrom, #filterDateTo').val('');
    
    // ✅ Reset filtering state và hiển thị all reports
    isFiltering = false;
    filteredReports = [...currentReports];
    currentPage = 1;
    
    // ✅ Ẩn filter results
    $('#reportsFilterResults').hide();
    
    displayReportsWithPagination(filteredReports);
}

async function generateReport() {
    try {
        const user = WorkManagement.currentUser();
        const formData = getFormData('generateReportForm');
        
        if (!formData.report_type) {
            showAlert('warning', 'Please select a report type');
            return;
        }
        
        // Show loading
        $('#generateSpinner').show();
        $('#generateReportForm button[type="submit"]').prop('disabled', true);
        
        let endpoint = '';
        let requestData = {};
        
        if (formData.report_type === 'weekly') {
            if (!formData.week) {
                showAlert('warning', 'Please select a week');
                return;
            }
            
            endpoint = formData.format === 'pdf' ? '/reports/generate-pdf' : '/reports/generate';
            requestData = {
                user_id: formData.target_user_id || user.id,
                week: formData.week
            };
        } else if (formData.report_type === 'summary') {
            if (user.role !== 'admin' && user.role !== 'leader') {
                showAlert('danger', 'Access denied');
                return;
            }
            
            if (!formData.summary_week) {
                showAlert('warning', 'Please select a week');
                return;
            }
            
            endpoint = formData.format === 'pdf' ? '/reports/summary-pdf' : '/reports/summary';
            requestData = {
                admin_id: user.id,
                week: formData.summary_week
            };
            
            // ✅ Admin có thể chọn group, leader thì không
            if (user.role === 'admin' && formData.group_id) {
                requestData.group_id = formData.group_id;
            }
        }
        
        console.log('Generating report with data:', requestData);
        console.log('Using endpoint:', endpoint);
        
        const response = await apiCall(endpoint, {
            method: 'POST',
            data: JSON.stringify(requestData)
        });
        
        showAlert('success', 'Report generated successfully!');
        $('#generateReportModal').modal('hide');
        resetForm('generateReportForm');
        loadReports();
        loadStatistics();
        
    } catch (error) {
        console.error('Error generating report:', error);
        let errorMessage = 'Error generating report';
        
        // ✅ Hiển thị thông báo lỗi chi tiết hơn
        if (error.message) {
            errorMessage += ': ' + error.message;
        } else if (error.responseJSON && error.responseJSON.message) {
            errorMessage += ': ' + error.responseJSON.message;
        }
        
        showAlert('danger', errorMessage);
    } finally {
        $('#generateSpinner').hide();
        $('#generateReportForm button[type="submit"]').prop('disabled', false);
    }
}

async function downloadReport(reportId) {
    try {
        window.open(`/api/reports/download/${reportId}`, '_blank');
        // ✅ XÓA loadStatistics(); - không cần refresh nữa
    } catch (error) {
        console.error('Error downloading report:', error);
        showAlert('danger', 'Error downloading report');
    }
}

async function deleteReport(reportId) {
    if (!confirm('Are you sure you want to delete this report?')) return;
    
    try {
        const user = WorkManagement.currentUser();
        
        await apiCall(`/reports/delete/${reportId}`, {
            method: 'DELETE',
            data: JSON.stringify({ user_id: user.id })
        });
        
        showAlert('success', 'Report deleted successfully');
        loadReports();
        loadStatistics();
        
    } catch (error) {
        console.error('Error deleting report:', error);
        showAlert('danger', 'Error deleting report');
    }
}
</script>
{% endblock %}